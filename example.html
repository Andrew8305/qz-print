<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">

    <title>QZ Tray Sample Page</title>
</head>

<script type="text/javascript" src="js/3rdparty/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/3rdparty/rsvp-3.1.0.min.js"></script>
<script type="text/javascript" src="js/qzTray.js"></script>

<style>
    .row {
        display: block;
        margin-bottom: 2em;
        text-align: justify;

        width: 100%;
    }

    .row div {
        text-align: left;
    }

    .row.spread:after {
        content: "";
        display: inline-block;
        width: 100%;
    }

    fieldset {
        display: inline-block;
        vertical-align: top;
        margin: 0 1%;
        padding: .5em;

        width: 25%;
        height: 12em;
        overflow-y: auto;

        background-color: #B1B1B1;
    }

    fieldset.wide {
        width: 45%;
    }

    fieldset.tall {
        height: auto;
    }

    fieldset div.columns-2 {
        width: 45%;
        float: left;
        padding: 2.5%;
    }

    fieldset div.columns-3 {
        width: 30%;
        float: left;
        padding: 1.3%;
    }

    legend {
        font-weight: bold;
        font-family: sans-serif;
    }

    h4 {
        margin-top: -2.5em;
    }

    label {
        display: block;
        margin: .25em;
    }

    button, input[type=text], input[type=number], select {
        display: block;
        width: 100%;
        margin: .25em 0;
    }

    .inline {
        display: inline-block;
    }

    .inline label {
        display: inline-block;
        width: 30%;
        margin: 0;
    }

    .inline input {
        display: inline-block;
        width: 65%;
        margin: 0;
    }
</style>


<body id="qz-page" style="background-color: #F1F1F1;">

<div class="row">
    <h1 id="title" style="margin:0;">QZ Print Plugin <span id="qz-version"></span></h1>
</div>

<div class="row spread">
    <fieldset id="connection">
        <legend>Connection</legend>

        <div>
            <div class="columns-2">
                <button type="button" onclick="startConnection();">Connect</button>
                <button type="button" onclick="endConnection();">Disconnect</button>
            </div>
            <div class="columns-2">
                <button type="button" onclick="listNetworkInfo();">List Network Info</button>
            </div>
        </div>
    </fieldset>

    <fieldset id="detection">
        <legend>Printer</legend>

        <div>
            <div class="columns-2">
                <label for="printerSearch">Search:</label>
                <input type="text" id="printerSearch" value="zebra" />
                <button type="button" onclick="findPrinter($('#printerSearch').val());">Find Printer</button>
                <button type="button" onclick="findDefaultPrinter();">Find Default Printer</button>
                <button type="button" onclick="findPrinters();">List All Printers</button>
            </div>

            <div class="columns-2">
                <span>Current printer:</span>

                <div id="configPrinter" style="font-weight: bold;">NONE</div>

                <button type="button" onclick="setPrinter($('#printerSearch').val());">Set To Searched Printer</button>
                <button disabled type="button" onclick="askForFile();">Set To File</button>
                <button disabled type="button" onclick="askForHost();">Set To Host</button>
            </div>
        </div>
    </fieldset>

    <fieldset id="serial" class="disabled">
        <legend>Serial</legend>

        <div>
            <div class="columns-2">
                <button disabled type="button" onclick="listSerialPorts();">List Ports</button>

                <label for="serialPort">Port Number</label>
                <input disabled type="text" id="serialPort" value="" />
            </div>

            <div class="columns-2">
                <button disabled type="button" onclick="openSerialPort();">Open Port</button>
                <button disabled type="button" onclick="sendSerialData();">Send Command</button>
                <button disabled type="button" onclick="closeSerialPort();">Close Port</button>
            </div>
        </div>
    </fieldset>
</div>

<div class="row spread">
    <fieldset id="raw" class="wide tall disabled">
        <legend>Raw Printing</legend>

        <div>
            <div class="row">
                <a href="https://qz.io/wiki/What-is-Raw-Printing" target="new">What is Raw Printing?</a>

                <span style="float: right;">
                    <a href="javascript:findPrinter('Epson');">Epson</a>&nbsp;
                    <a href="javascript:findPrinter('Citizen');">Citizen</a>&nbsp;
                    <a href="javascript:findPrinter('Star');">Star</a>&nbsp;
                </span>
            </div>

            <div class="row">
                <div class="columns-3">
                    <button disabled type="button" onClick="printEPL();">Print EPL</button>
                    <button disabled type="button" onClick="printZPL();">Print ZPL</button>
                    <br />

                    <button disabled type="button" onClick="printESCP();">Print ESCP</button>
                    <br />

                    <button disabled type="button" onClick="printEPCL();">Print EPCL</button>
                    (Zebra Card Printer)<br />
                </div>

                <div class="columns-3">
                    <button disabled type="button" onClick="print64();">Print Base64</button>
                    <button disabled type="button" onClick="printXML();">Print XML</button>
                    <button disabled type="button" onClick="printHex();">Print Hex</button>
                    <br />

                    <button disabled type="button" onClick="printFile('zpl_sample.txt');">Print zpl_sample.txt</button>
                    <button disabled type="button" onClick="printFile('fgl_sample.txt');">Print fgl_sample.txt</button>
                    <button disabled type="button" onClick="printFile('epl_sample.txt');">Print epl_sample.txt</button>
                    <br />
                </div>

                <div class="columns-3" style="border-left: 1px dashed #CCC;">
                    <h4>Options</h4>

                    <label for="rawAltPrinting">
                        Alternate Printing:
                        <input disabled type="checkbox" id="rawAltPrinting" />
                    </label>

                    <label for="rawEncoding">Encoding</label>
                    <input disabled type="text" id="rawEncoding" />

                    <label for="rawEndOfDoc">End Of Doc</label>
                    <input disabled type="text" id="rawEndOfDoc" />

                    <label for="rawLanguage">Language</label>
                    <input disabled type="text" id="rawLanguage" />

                    <label for="rawPerSpool">Per Spool</label>
                    <input disabled type="number" id="rawPerSpool" />

                    <label for="rawPrinterTray">Printer Tray</label>
                    <input disabled type="text" id="rawPrinterTray" />

                    <button type="button" style="margin-top: 2em; color: #F00;" onclick="resetRawOptions();">Reset</button>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset id="postscript" class="wide tall">
        <legend>Postscript Printing</legend>

        <div>
            <div class="row">
                <a href="https://qz.io/wiki/what-is-postScript-printing" target="new">What is Postsript Printing?</a>

                <span style="float: right;">
                    <a href="javascript:findPrinter('XPS');">Microsoft XPS</a>&nbsp;
                    <a href="javascript:findPrinter('PDF');">PDF</a>&nbsp;
                </span>
            </div>

            <div class="row">
                <div class="columns-3">
                    <button type="button" onClick="printHTML();">Print HTML</button>
                    <button type="button" onClick="printPage();">Print Current Page</button>
                    <br />

                    <button type="button" onClick="printPDF();">Print PDF</button>
                    <br />

                    <button type="button" onClick="printImage(false);">Print PostScript Image</button>
                    <button type="button" onClick="printImage(true);">Print Scaled PostScript Image</button>
                </div>

                <div class="columns-3" style="border-left: 1px dashed #CCC;">
                    <h4>Options</h4>

                    <label for="psColorType">Color Type</label>
                    <select id="psColorType">
                        <option value="color">Color</option>
                        <option value="greyscale">Greyscale</option>
                        <option value="blackwhite">Black & White</option>
                    </select>

                    <label for="psCopies">Copies</label>
                    <input type="number" id="psCopies" />

                    <label for="psDensity">Density</label>
                    <input type="number" id="psDensity" />

                    <label for="psDuplex">
                        Duplex:
                        <input type="checkbox" id="psDuplex" />
                    </label>

                    <label for="psOrientation">Orientation</label>
                    <select id="psOrientation">
                        <option value="">Default</option>
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                        <option value="reverse-landscape">Landscape - Reverse</option>
                    </select>

                    <label for="psPaperThickness">Paper Thickness</label>
                    <input disabled type="number" step="any" id="psPaperThickness" />

                    <label for="psRotation">Rotation</label>
                    <input type="number" step="any" id="psRotation" />

                    <button type="button" style="margin-top: 2em; color: #F00;" onclick="resetPSOptions();">Reset</button>
                </div>

                <div class="columns-3">
                    <label>Units</label>
                    <span>
                        <label style="float: left;">
                            <input type="radio" name="psUnits" id="psUnitsIN" value="in" />
                            IN
                        </label>
                        <label style="float: left;">
                            <input type="radio" name="psUnits" id="psUnitsMM" value="mm" />
                            MM
                        </label>
                        <label style="float: left;">
                            <input type="radio" name="psUnits" id="psUnitsCM" value="cm" />
                            CM
                        </label>
                        <label style="clear: both;"></label>
                    </span>

                    <label for="psMargins">Margins</label>
                    (
                    <label for="psMarginsActive" class="inline">Individual:</label>
                    <input type="checkbox" id="psMarginsActive" onclick="checkMarginsActive();">
                    )
                    <input type="number" step="any" id="psMargins" />
                    <span class="inline" id="psMarginsGroup">
                        <label for="psMarginsTop">Top:</label>
                        <input type="number" step="any" id="psMarginsTop" />
                        <label for="psMarginsRight">Right:</label>
                        <input type="number" step="any" id="psMarginsRight" />
                        <label for="psMarginsBottom">Bottom:</label>
                        <input type="number" step="any" id="psMarginsBottom" />
                        <label for="psMarginsLeft">Left:</label>
                        <input type="number" step="any" id="psMarginsLeft" />
                    </span>
                    <br />

                    <label class="inline">Size</label>
                    (
                    <label for="psSizeActive" class="inline">Enable:</label>
                    <input type="checkbox" id="psSizeActive" onclick="checkSizeActive();" />
                    )
                    <span class="inline" id="psSizeGroup">
                        <label for="psSizeWidth">Width:</label>
                        <input type="number" step="any" id="psSizeWidth" />
                        <label for="psSizeHeight">Height:</label>
                        <input type="number" step="any" id="psSizeHeight" />
                        <label for="psSizeScale">Scale Image:</label>
                        <input type="checkbox" id="psSizeScale" />
                    </span>
                </div>
            </div>
        </div>
    </fieldset>
</div>

</body>


<!--TODO - better commenting-->
<!--TODO - checks for open-->
<!--TODO - alert on printing without a printer-->
<script>
    /// Connection ///
    function startConnection() {
        qz.websocket.connect({ usingSecure: false }).then(function() {
            setBackground('#FFFFFF');
            $("#qz-version").html(qz.getVersion());
        }).catch(handleError);
    }

    function endConnection() {
        qz.websocket.disconnect().then(function() {
            setBackground('#B1B1B1');
        }).catch(handleError);
    }

    function findNetworkInfo() {
        qz.websocket.getNetworkInfo().then(function(data) {
            var macFormatted = '';
            for(var i = 0; i < data.macAddress.length; i++) {
                macFormatted += data.macAddress[i];
                if (i % 2 == 1 && i < data.macAddress.length - 1) {
                    macFormatted += ":";
                }
            }

            alert("IP: " + data.ipAddress + "\nPhysical Address: " + macFormatted);
        }).catch(function(err) { console.error(err); });
    }


    /// Detection ///
    function findPrinter(query) {
        $("#printerSearch").val(query);
        qz.printers.find(query).then(function(data) {
            alert("Found: " + data);
        }).catch(function(err) { console.error(err); });
    }

    function findDefaultPrinter() {
        qz.printers.getDefault().then(function(data) {
            alert("Found: " + data);
        }).catch(function(err) { console.error(err); });
    }

    function findPrinters() {
        qz.printers.find().then(function(data) {
            var list = '';
            for(var i = 0; i < data.length; i++) {
                list += data[i] + "\n";
            }

            alert("Available printers:\n\n" + list);
        }).catch(function(err) { console.error(err); });
    }


    /// Raw Printers ///
    function printEPL() {
        $("#rawLanguage").val("EPL");
        var config = getUpdatedConfig();

        var printData = [
            '\nN\n',
            'q609\n',
            'Q203,26\n',
            'B5,26,0,1A,3,7,152,B,"1234"\n',
            'A310,26,0,3,1,1,N,"SKU 00000 MFG 0000"\n',
            'A310,56,0,3,1,1,N,"QZ PRINT APPLET"\n',
            'A310,86,0,3,1,1,N,"TEST PRINT SUCCESSFUL"\n',
            'A310,116,0,3,1,1,N,"FROM SAMPLE.HTML"\n',
            'A310,146,0,3,1,1,N,"QZINDUSTRIES.COM"\n',
            { type: 'raw', format: 'visual', data: getPath() + '/assets/img/image_sample_bw.png', options: { x: 150, y: 300 } },
            '\nP1,1\n'
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printZPL() {
        $("#rawLanguage").val("ZPLII");
        var config = getUpdatedConfig();

        var printData = [
            '^XA\n',
            '^FO50,50^ADN,36,20^FDPRINTED USING QZ PRINT PLUGIN ' + qz.getVersion() + '\n',
            { type: 'raw', format: 'visual', data: getPath() + '/assets/img/image_sample_bw.png' },
            '^F5\n',
            '^XZ\n'
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printESCP() {
        $("#rawLanguage").val("ESCP");
        var config = getUpdatedConfig();

        var printData = [
            { type: 'raw', format: 'visual', data: getPath() + '/assets/img/image_sample_bw.png', options: { dotDensity: 'single' } },
            { type: 'raw', data: '\nPrinted using qz-print plugin.\n\n\n\n\n\n' }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printEPCL() {
        var config = getUpdatedConfig();

        var printData = [];
        $.merge(printData, convertEPCL('+RIB 4'));     // Monochrome ribbon
        $.merge(printData, convertEPCL('F'));          // Clear monochrome print buffer
        $.merge(printData, convertEPCL('+C 8'));       // Adjust monochrome intensity
        $.merge(printData, convertEPCL('&R'));         // Reset magnetic encoder
        $.merge(printData, convertEPCL('&CDEW 0 0'));  // Set R/W encoder to ISO default
        $.merge(printData, convertEPCL('&CDER 0 0'));  // Set R/W encoder to ISO default
        $.merge(printData, convertEPCL('&SVM 0'));     // Disable magnetic encoding verifications
        $.merge(printData, convertEPCL('T 80 600 0 1 0 45 1 QZ INDUSTRIES'));   // Write text buffer
        $.merge(printData, convertEPCL('&B 1 123456^INDUSTRIES/QZ^789012'));	// Write mag strip buffer
        $.merge(printData, convertEPCL('&E*'));        // Encode magnetic data
        $.merge(printData, convertEPCL('I 10'));       // Print card (10 returns to print ready pos.)
        $.merge(printData, convertEPCL('MO'));         // Move card to output hopper

        qz.print(config, printData).catch(displayError);
    }

    /**
     * EPCL helper function that appends a single line of EPCL data, taking into account
     * special EPCL NUL characters, data length, escape character and carriage return
     */
    function convertEPCL(data) {
        if (data == null || data.length == 0) {
            log.warn('Empty EPCL data, skipping');
        }

        // Data length for this command, in 2 character Hex (base 16) format
        var len = (data.length + 2).toString(16);
        if (len.length < 2) { len = '0' + len; }

        return [
            { type: 'raw', format: 'hex', data: 'x00x00x00' },  // Append 3 NULs
            { type: 'raw', format: 'hex', data: 'x' + len },    // Append our command length, in base16
            { type: 'raw', format: 'plain', data: data },       // Append our command
            { type: 'raw', format: 'plain', data: '\r' }        // Append carriage return
        ];
    }

    function printBase64() {
        var config = getUpdatedConfig();

        // Send base64 encoded characters/raw commands to qz using data type 'base64'.
        // This will automatically convert provided base64 encoded text into text/ascii/bytes, etc.
        // This example is for EPL and contains an embedded image.
        // Please adapt to your printer language.

        //noinspection SpellCheckingInspection
        var printData = [
            {
                type: 'raw',
                format: 'base64',
                data: 'Ck4KcTYwOQpRMjAzLDI2CkI1LDI2LDAsMUEsMyw3LDE1MixCLCIxMjM0IgpBMzEwLDI2LDAsMywx' +
                'LDEsTiwiU0tVIDAwMDAwIE1GRyAwMDAwIgpBMzEwLDU2LDAsMywxLDEsTiwiUVogUFJJTlQgQVBQ' +
                'TEVUIgpBMzEwLDg2LDAsMywxLDEsTiwiVEVTVCBQUklOVCBTVUNDRVNTRlVMIgpBMzEwLDExNiww' +
                'LDMsMSwxLE4sIkZST00gU0FNUExFLkhUTUwiCkEzMTAsMTQ2LDAsMywxLDEsTiwiUVpJTkRVU1RS' +
                'SUVTLkNPTSIKR1cxNTAsMzAwLDMyLDEyOCz/////////6SSSX///////////////////////////' +
                '//////////6UlUqX////////////////////////////////////8kqkpKP/////////////////' +
                '//////////////////6JUpJSVf//////////////////////////////////9KpKVVU+////////' +
                '//////////////////////////8KSSlJJf5/////////////////////////////////9KUqpVU/' +
                '/7////////////////////////////////9KqUkokf//P///////////////////////////////' +
                '+VKUqpZP//+P///////////////////////////////ElKUlSf///9f/////////////////////' +
                '////////+ipSkqin////y/////////////////////////////+lVUpUlX/////r////////////' +
                '/////////////////qlJKUql/////+n////////////////////////////BFKVKUl//////8v//' +
                '/////////////////////////zVSlKUp///////0f//////////////////////////wiSlSUpf/' +
                '//////q///////////////////////////KqlJUpV///////+R//////////////////////////' +
                '4UlKSpSX///////9T/////////6L///////////////BKlKpSqP///////1X////////0qg/23/V' +
                'VVVVVVf//8CSlJKklf///////kv///////+pS0/JP8AAAAAAB///wFSlSSpV///////+pf//////' +
                '/pUoq+qfwAAAAAAH//+AClSqpUT///////9S///////8pJUlkr+AAAAAAA///4AFJSSSUv//////' +
                '/yl///////KVUpTUv8AAAAAAH///gBKSqlVU////////lX//////6UkqoiU/wAAAAAA///+ABKpJ' +
                'Uko////////JH//////UpIiqlJ/AAAAAAD///wACkSUpJX///////6q//////6pVVSqiv4AAAAAA' +
                'f///AAJVVIqpP///////pI//////pSVtSSq/wAAAAAD///8AAJSlVJVf///////Sp/////8Sq//U' +
                'qL/ttttoAP///wAAUpVSpJ///////+pT/////qkn//UlH/////AB////AABKUSpSX///////5Sn/' +
                '///+lJ//+pS/////4AP///8AABKUkpVP///////ylP////1Kv//+qr/////AA////4AAKVVJUl//' +
                '/////+lKf////KS///8kv////8AH////gAAKSSpJR///////9Kq////9Kv///5Kf////gAf///+A' +
                'AAUlUqov///////1JT////lS////qn////8AD////4AABKpKSqf///////Skj///+kr////JH///' +
                '/wAf////wAACkqUlK///////8pKv///ypf///9V////+AD/////AAAFKUVSj///////wqlP///JT' +
                '////yR////wAP////8AAAFKqkpv///////JSlf//9Sv////U/////AB/////4AAAVIpKRf//////' +
                '+ElV///pS////8of///4AP/////gAAASZVKr///////4qkj///Sn////0v////AA//////AAABUS' +
                'VJH///////glJn//8pP////KH///8AH/////+AAACtUlVf//////+ClRP//qV////9K////gA///' +
                '///4AAACEpJK///////8BSqf/+lX////yr///8AD//////wAAAVUqVH///////gUlU//5Rf////R' +
                'P///gAf//////gAAApKqTP//////8AVSV//pU////6qf//+AD//////+AAAAqkki//////8AEpVL' +
                '/+qP////1L///wAP//////4AAACSVVB/////+AFUpKX/9KP////Sv//+AB///////AAAAEqSgH//' +
                '//+ACkpSUv/lV////6k///4AP//////+AAAAUlSgf////gAJKRUpf/ST////1J///AA///////4A' +
                'AAAVJVB////gAtVFUpV/8lX///+Vf//4AH///////gAAABKSSD///wASSVVJSR/1Vf///8kf//gA' +
                '///////+AAAABVUof//4AElUpKqqv/SL////1L//8AD///////4AAAABJJQ//8AFVJKVKSSP+qj/' +
                '///Kv//gAf///////gAAAAKSpT/+ACkqSlKUkqf5Rf///6S//+AD///////+AAAAAKqpP/ABJKVS' +
                'klKqU/xUf///qp//wAP///////4AAAAAkko+gASVKUlVKlKX/VK///9Sf/+AB////////gAAAACp' +
                'UrgAKqVKVJKSlKf+Sl///0kf/4AP///////+AAAAABSVIAFJUlKqSUpKV/0pX//8qr//AA//////' +
                '//8AAAAACklACSopKSVUqVKX/qpH//okv/4AH////////gAAAAAVVKBUpUqUkkpKSk//SSv/xVK/' +
                '/AAAAAAD////AAAAAAJKWSUpVKVVUqVSp/+qqH9SlR/8AAAAAAH///4AAAAABSUklJSSlJJKUkpf' +
                '/8klQFSo//gAAAAAA////wAAAAABVKqlUkqlSqkqqU//6pUqkkof8AAAAAAB/r//AAAAAAElEpSK' +
                'qSlSSpJKL//pUqpVKr/wAAAAAAP8v/8AAAAAAJLKUqkkpSqkqSVf//yUkpKSv+AAAAAAAfqf/wAA' +
                'AAAAVClKVVUoklUqqp///UpKVVS/wAAAAAAD+S//AAAAAAAlpSkkkpVKkpKSX///JVKTpR+AAAAA' +
                'AAH9X/8AAAAAABRUpVJUqqSpSUlf///SSk/Sv4AAAAAAA/y//wAAAAAAFSVUlSUkUkpUqr////VS' +
                'v9S/AAAAAAAB/3//AAAAAAAFUkpSlJMqqUpJP////13/pT////////////8AAAAAAAEpJSlSqUkk' +
                'pVS////////Un////////////wAAAAAABJVSlSpUqpUpJX///////8q/////////////gAAAAAAC' +
                'pSqkkpKSUpSSP///////5L////////////+AAAAAAACSkVVKSklKpVV///////+SX///////////' +
                '/4AAAAAAAFSqJKlSqqiVSX///////9U/////////////gAAAAAAASpVSlSkklVJU////////yr//' +
                '//////////+AAAAAAAAkpJSklKpKSUp////////kn////////////4AAAAAAABJSqlKqkqUqVf//' +
                '/////5K/////////////gAAAAAAACpUlKpJKUqlI////////1L////////////+AAAAAAAAFSVKS' +
                'SqkpFKX////////SX////////////4AAAAAAAAiklKlSSpTKKv///////9U/////////////wAAA' +
                'AAAABSpSlSqlSiVJ////////pV/////////////AAAAAAAAVUpSkklSlUqX////////Uv///////' +
                '/////8AAAAAAAAkqUpVJJSqpVf///////8pf////////////4AAAAAAAFJKUpKqUpJUT////////' +
                '4r/////////////wAAAAAAAKqVKVKUqSSVX///////+Uv/////////////gAAAAAAASUlKSkpKql' +
                'S////////+qf/////////////AAAAAAAEkpKUlUpJJCn////////iH///////////wAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/4B+A8AH/AAAAA' +
                'AAAAAAAAAAAAAA//AAfwD4H4HwAAf/4H4DwB//gAAAAAAAAAAAAAAAAAD/+AB/APgfgfAAB//wfw' +
                'PAf/+AAAAAAAAAAAAAgAAAAP/8AH8AfB+D4AAH//B/g8D//4AAAAAAAAAAAADwAAAA//4A/4B8H4' +
                'PgAAfB+H+DwP4HgAAAAAAAAAAAAPwAAAD4fgD/gHw/w+AAB8D4f8PB+AGAAAAAAAAAAAAA/wAAAP' +
                'g+Af/AfD/D4AAHwPh/48HwAAAAAAAAAAAAAAB/4AAA+D4B98A+P8PAAAfA+Hvjw+AAAAAAAAAAAA' +
                'AAAB/4AAD4PgH3wD4/x8AAB8H4e/PD4AAAAAAAAAAAAAAAB/8AAPh8A+PgPn/nwAAH//B5+8Pg/4' +
                'AH/j/x/4/8f+AA/8AA//wD4+A+eefAAAf/4Hj7w+D/gAf+P/H/j/x/4AA/wAD/+APj4B5554AAB/' +
                '/AeP/D4P+AB/4/8f+P/H/gAD/AAP/wB8HwH3nvgAAH/wB4f8Pw/4AH/j/x/4/8f+AA/8AA//AH//' +
                'Af+f+AAAfAAHg/wfAPgAAAAAAAAAAAAAf/AAD5+A//+B/w/4AAB8AAeD/B+A+AAAAAAAAAAAAAH/' +
                'gAAPj8D//4D/D/AAAHwAB4H8H+D4AAAAAAAAAAAAB/4AAA+H4P//gP8P8AAAfAAHgPwP//gAAAAA' +
                'AAAAAAAP8AAAD4fh+A/A/w/wAAB8AAeA/Af/+AAAAAAAAAAAAA/AAAAPg/HwB8B+B+AAAHwAB4B8' +
                'Af/4AAAAAAAAAAAADwAAAA+B+fAHwH4H4AAAfAAHgHwAf4AAAAAAAAAAAAAIAAAAD4H/8Afgfgfg' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
                'AAAAAAAAAAAAAAAAAAAAAAAAClAxLDEK'
            }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printXML() {
        var config = getUpdatedConfig();

        var printData = [
            { type: 'raw', format: 'xml', data: getPath() + '/assets/zpl_sample.xml', options: { xmlTag: 'v7:Image' } }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printHex() {
        var config = getUpdatedConfig();

        var printData = [
            { type: 'raw', format: 'hex', data: '4e0d0a713630390d0a513230332c32360d0a42352c32362c' },
            { type: 'raw', format: 'hex', data: '302c31412c332c372c3135322c422c2231323334220d0a41' },
            { type: 'raw', format: 'hex', data: '3331302c32362c302c332c312c312c4e2c22534b55203030' },
            { type: 'raw', format: 'hex', data: '303030204d46472030303030220d0a413331302c35362c30' },
            { type: 'raw', format: 'hex', data: '2c332c312c312c4e2c22515a205072696e7420506c756769' },
            { type: 'raw', format: 'hex', data: '6e220d0a413331302c38362c302c332c312c312c4e2c2254' },
            { type: 'raw', format: 'hex', data: '657374207072696e74207375636365737366756c220d0a41' },
            { type: 'raw', format: 'hex', data: '3331302c3131362c302c332c312c312c4e2c2266726f6d20' },
            { type: 'raw', format: 'hex', data: '73616d706c652e68746d6c220d0a413331302c3134362c30' },
            { type: 'raw', format: 'hex', data: '2c332c312c312c4e2c227072696e7448657828292066756e' },
            { type: 'raw', format: 'hex', data: '6374696f6e2e220d0a50312c310d0a' }
        ];

        qz.print(config, printData);
    }

    function printFile(file) {
        var config = getUpdatedConfig();

        var printData = [
            { type: 'raw', format: 'file', data: getPath() + '/assets/' + file }
        ];

        qz.print(config, printData).catch(displayError);
    }


    /// PS Printers ///
    function printHTML() {
        var config = getUpdatedConfig();

        var colA = '<h2>*&nbsp; QZ Print Plugin HTML Printing &nbsp;*</h2>' +
                '<span style="color: #F00;">Version:</span> ' + qz.getVersion() + '<br/>' +
                '<span style="color: #F00;">Visit:</span> https://qz.io/';
        var colB = '<img src="' + getPath() + '/assets/img/image_sample.png">';

        var printData = [
            {
                type: 'html',
                format: 'plain',
                data: '<html>' +
                '   <table style="font-family: monospace; border: 1px;">' +
                '       <tr style="height: 6cm;">' +
                '           <td valign="top">' + colA + '</td>' +
                '           <td valign="top">' + colB + '</td>' +
                '       </tr>' +
                '   </table>' +
                '</html>',
                options: { pageWidth: 640 }
            }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printPage() {
        var config = getUpdatedConfig();

        var printData = [
            { type: 'html', format: 'file', data: getPath() + '/example.html' }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printPDF() {
        var config = getUpdatedConfig();

        var printData = [
            { type: 'pdf', data: getPath() + '/assets/pdf_sample.pdf' }
        ];

        qz.print(config, printData).catch(displayError);
    }

    function printImage(scaling) {
        if (scaling) {
            $("#psSizeActive").prop('checked', true);
            $("#psSizeScale").prop('checked', true);
            checkSizeActive();
        }
        var config = getUpdatedConfig();

        var printData = [
            { type: 'image', data: getPath() + '/assets/img/image_sample.png' }
        ];

        qz.print(config, printData).catch(displayError);
    }


    /// Serial ///
    function listSerialPorts() {
        console.warn("Not Implemented!"); //TODO
    }

    function openSerialPort() {
        console.warn("Not Implemented!"); //TODO
    }

    function sendSerialData() {
        console.warn("Not Implemented!"); //TODO
    }

    function closeSerialPort() {
        console.warn("Not Implemented!"); //TODO
    }


    /// Resets ///
    function resetRawOptions() {
        $("#rawPerSpool").val(1);
        $("#rawLanguage").val(null);
        $("#rawEncoding").val(null);
        $("#rawEndOfDoc").val(null);
        $("#rawPrinterTray").val(null);
        $("#rawAltPrinting").prop('checked', false);
    }

    function resetPSOptions() {
        $("#psColorType").val("color");
        $("#psCopies").val(1);
        $("#psDensity").val(72);
        $("#psDuplex").prop('checked', false);
        $("#psOrientation").val("");
        $("#psPaperThickness").val(null);
        $("#psRotation").val(0);
        $("#psUnitsIN").prop('checked', true);

        $("#psMargins").val(0).css('display', '');
        $("#psMarginsTop").val(0);
        $("#psMarginsRight").val(0);
        $("#psMarginsBottom").val(0);
        $("#psMarginsLeft").val(0);
        $("#psMarginsActive").prop('checked', false);
        $("#psMarginsGroup").css('display', 'none');

        $("#psSizeWidth").val('');
        $("#psSizeHeight").val('');
        $("#psSizeScale").prop('checked', false);
        $("#psSizeActive").prop('checked', false);
        $("#psSizeGroup").css('display', 'none');
    }

    function checkSizeActive() {
        if (valu("psSizeActive", true)) {
            $("#psSizeGroup").css('display', '');
        } else {
            $("#psSizeGroup").css('display', 'none');
        }
    }

    function checkMarginsActive() {
        if (valu("psMarginsActive", true)) {
            $("#psMarginsGroup").css('display', '');
            $("#psMargins").css('display', 'none');
        } else {
            $("#psMarginsGroup").css('display', 'none');
            $("#psMargins").css('display', '');
        }
    }


    /// Page load ///
    $(document).ready(function() {
        setBackground('#FFF1D0');
        resetRawOptions();
        resetPSOptions();

        startConnection();
    });

    qz.websocket.setClosedCallbacks(function(evt) {
        setBackground('#B1B1B1');
        console.log(evt);
    });

    qz.websocket.setErrorCallbacks(handleError);


    /// Helpers ///
    function handleError(err) {
        setBackground('#F5A9A9');
        console.error(err);
    }

    function displayError(err) {
        alert(err);
        console.error(err);
    }

    function setBackground(color) {
        $("#qz-page").children().children("fieldset").not(".disabled").css("background-color", color);
    }

    function getPath() {
        var path = window.location.href;
        return path.substring(0, path.lastIndexOf("/"));
    }

    function valu(id, isCheckable, groupName) {
        if (id[0] != '#') { id = '#' + id; }

        if (!isCheckable) {
            var val = $(id).val();
            if (val === "") { val = null; }
            return val;
        } else {
            if (groupName === undefined) {
                return $(id).prop("checked");
            } else {
                return $("input[name=" + groupName + "]:checked").val();
            }
        }
    }


    /// QZ Config ///
    var cfg = null;
    function getUpdatedConfig() {
        if (cfg == null) {
            cfg = qz.configs.create(null);
        }

        updateConfig();
        return cfg
    }

    function updateConfig() {
        var psSize = null;
        if (valu("psSizeActive", true)) {
            psSize = {
                width: valu("psSizeWidth"),
                height: valu("psSizeHeight"),
                scaleImage: valu("psSizeScale", true)
            };
        }

        var psMargins = valu("psMargins");
        if (valu("psMarginsActive", true)) {
            psMargins = {
                top: valu("psMarginsTop"),
                right: valu("psMarginsRight"),
                bottom: valu("psMarginsBottom"),
                left: valu("psMarginsLeft")
            };
        }

        cfg.reconfigure({
                            altPrinting: valu("rawAltPrinting", true),
                            encoding: valu("rawEncoding"),
                            endOfDoc: valu("rawEndOfDoc"),
                            language: valu("rawLanguage"),
                            perSpool: valu("rawPerSpool"),
                            printerTray: valu("rawPrinterTray"),

                            colorType: valu("psColorType"),
                            copies: valu("psCopies"),
                            density: valu("psDensity"),
                            duplex: valu("psDuplex", true),
                            margins: psMargins,
                            orientation: valu("psOrientation"),
                            paperThickness: valu("psPaperThickness"),
                            rotation: valu("psRotation"),
                            size: psSize,
                            units: valu("", true, "psUnits")
                        });
    }

    function askForFile() {
        var file = prompt("Print to file:", "C:\\tmp\\test-file.txt");

        setPrinter({ file: file });
    }

    function askForHost() {
        var host = prompt("Print to host:", "192.168.1.254");
        var port = prompt("Use port:", "9100");

        setPrinter({ host: host, port: port });
    }

    function setPrinter(printer) {
        var cf = getUpdatedConfig();
        cf.setPrinter(printer);

        if (typeof printer === 'object' && printer.name == undefined) {
            var shown;
            if (printer.file != undefined) {
                shown = "FILE: " + printer.file;
            }
            if (printer.host != undefined) {
                shown = "HOST: " + printer.host + ":" + printer.port;
            }

            $("#configPrinter").html(shown);
        } else {
            if (printer.name != undefined) {
                printer = printer.name;
            }

            qz.printers.find(printer).then(function(data) {
                if (data == undefined) {
                    data = 'NONE';
                }
                $("#configPrinter").html(data);
            }).catch(function(err) {
                console.error(err);
            });
        }
    }
</script>

</html>
