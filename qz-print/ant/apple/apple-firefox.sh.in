#!/bin/bash
###############################################################################
#           ${socket.name} Apple OS X Firefox Certificate Utility                    #
###############################################################################
#  Description:                                                               #
#   INSTALL:                                                                  #
#     1. Searches for Firefox installation using lsregister                   #
#     2. Parses defaults/pref for potential Firefox AutoConfig conflicts      #
#     3. Imports certificate into Firefox web browser using AutoConfig file   #
#                                                                             #
#   UNINSTALL:                                                                #
#     1.  FIXME - THIS IS NOT IMPLEMENTED                                     #
#                                                                             #
#  Depends:                                                                   #
#    lsregister (provided by Apple's launch services)                         #
#                                                                             #
#  Usage:                                                                     #
#    $ ./apple-firefox "install" FIXME - THIS IS IGNORED                      #
#    $ ./apple-firefox "uninstall" FIXME - THIS IS IGNORED                    #
#                                                                             #
###############################################################################

# Array of possible Firefox application names
appnames=("Firefox")	# "Firefox" "IceWeasel" "etc"

# Array of possible pref tag conflicts
conflicts=("general.config.filename")

# Array of possible lsregister command locations
lsreg=("/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister")

appdir=""

#
# Calls lsregister -dump and parses the output for "/Firefox.app", etc.  Returns the very first result found.
#
function get_appdir()
{
	for i in ${lsreg[@]}; do
		for j in ${appnames[@]}; do
			if [ -f $i ]; then
				appdir=$($i -dump |grep -E "/$j.app$" |cut -d'/' -f2- |head -1)
				return 0
			fi
		done
	done
	return 1
}

get_appdir

# Firefox was not found, skip Firefox certificate installation
if [ -z "$appdir" ]; then
	echo -e " - [skipping] Firefox not found"
	exit 0
fi

echo -e "\nSearching for Firefox AutoConfig conflicts..."
appdir="/$appdir"
bindir="$appdir/Contents/MacOS/"
prefdir="$appdir/Contents/Resources/defaults/pref"

#
# Iterate over each preference file looking for conflicts
#
for i in $prefdir/*; do
	if [ "$i" == "$prefdir/${firefoxprefs.name}" ]; then
		# skip, ${socket.name} preferences
		echo -e "${bash.skipped} Ignoring ${socket.name} preference file \"${firefoxprefs.name}\""
		continue
	fi
	for j in ${conflicts[@]}; do
		grep '"$j"' $i &>/dev/null
		dquotes=$?
		grep "'$j'" $i &>/dev/null
		squotes=$?
		if [ $dquotes -eq 0 ] || [ $squotes -eq 0 ]; then 
		   echo -e "${bash.error} Conflict found while looking for \"$j\"\n\tin $i"
		   exit 1
		fi
	done
done

echo -e "${bash.success} No conflicts found"

echo -e "\nRegistering with Firefox..."
cp "${firefoxprefs.install}" "$prefdir/${firefoxprefs.name}"
cp "${firefoxconfig.install}" "$bindir/${firefoxconfig.name}"

bcert="\-\-\-\-\-BEGIN CERTIFICATE\-\-\-\-\-"
ecert="\-\-\-\-\-END CERTIFICATE\-\-\-\-\-"

# Get raw base64 data only
certdata=$(cat $HOME/Desktop/test.crt | tr -d '\n' |tr -d "$bcert" |tr -d "$ecert")

if [ -f "$bindir/${firefoxconfig.name}" ]; then
	echo -e "${bash.success} Check Firefox config exists"
else
	echo -e "${bash.error} Check Firefox config exists"
fi

# Replace ${certData} with the base64 string
perl -pi -e "s#\\\${certData}#$certdata#g" "$bindir/${firefoxconfig.name}"
echo -e 

