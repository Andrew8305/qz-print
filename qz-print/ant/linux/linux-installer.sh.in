#!/bin/bash
###############################################################################
#                         ${socket.name} Linux Installer                             #
###############################################################################
#  Description:                                                               #
#    1. Stops any existing instances                                          #
#    2. Patches Ubuntu Unity Desktop for tray icon support                    #
#    3. Installs to current users home directory                              #
#                                                                             #
#  Usage:                                                                     #
#    $ chmod +x linux-installer.sh                                            #
#    $ ./linux-installer.sh                                                   #
#                                                                             #
###############################################################################

destdir="${linux.installdir}"
shortcut="$HOME/Desktop/${socket.name}.desktop"
jarfile="${destdir}/${build.socket.name}.jar"

# OK dialog
height=8; width=41
function confirm_dialog() {
   dialog --title "Install ${socket.name}" --backtitle "Install ${socket.name}" --yesno "$1" $height $width
   if [ $? -ne 0 ]; then
      echo -e "\n\n${bash.aborted}\n"
      exit 1
   fi
}

# Progress dialog
function progress_dialog() {
   echo "$1" | dialog --title "Install ${socket.name}" \
    --backtitle "Install ${socket.name}" \
    --gauge "$2" $height $width
}

function check_java() {
   curver=$(java -version 2>&1 | grep -i version | cut -d'"' -f2 | cut -d'.' -f1-2) 
   minver="${javac.target}"

   if [ -z "$curver" ]; then
      curver="0.0"
   fi

   if [ $(echo "$curver>=$minver" | bc -l) -eq 0 ]; then
      echo -e "\n\n${bash.failure}\n"
      echo "Please install Java ${javac.target} or higher to continue\n"
   fi
}

confirm_dialog "Are you sure you want to install ${socket.name}?"

progress_dialog 5 "Checking for Java ${javac.target}+..."
check_java

progress_dialog 10 "Stopping any running versions..."
pkill -f "java -jar ${jarfile}"

progress_dialog 20 "Stopping any running versions..."
rm -rf "${destdir}" > /dev/null 2>&1

progress_dialog 25 "Creating directory..."
mkdir -p "${destdir}" > /dev/null 2>&1

progress_dialog 30 "Installing new version..."
cp -R ./ "${destdir}"
rm "${destdir}/`basename $0`"

progress_dialog 40 "Creating desktop shortcut..."
echo "[Desktop Entry]
Type=Application
Name=${socket.name}
Exec=java -jar \"${jarfile}\"
Path=${destdir}
Icon=${destdir}/${linux.icon}
Terminal=false
Comment=${socket.name}" > "${shortcut}"
chmod +x "${shortcut}"

# Ubuntu process restarter
function restart_it() {
    # Check for running process, kill it
    ps -e |grep -q $1
    if [ $? -eq 0 ]; then
        progress_dialog $2 "Killing $1..."
        killall -w $1 > /dev/null 2>&1
    fi

    # Make sure process isn't running, start it
    ps -e |grep -q $1
    if [ $? -ne 0 ]; then
        progress_dialog $(($2 + 5)) "Starting $1..."
        nohup $1 > /dev/null 2>&1 &
    fi
}

# Check for Ubuntu to fix System Tray
grep -q "Ubuntu" /etc/lsb-release
if [ $? -eq 0 ]; then
    echo " - Ubuntu detected.  Restarting Unity Panel..."
    gsettings set com.canonical.Unity.Panel systray-whitelist "['all']" > /dev/null 2>&1
    restart_it unity-panel-service 50
    restart_it unity-2d-panel 60
fi

progress_dialog 70 "Generating certificate..."
chmod +x "${linux.keygen.out}"  > /dev/null 2>&1
"${linux.keygen.out}"

cd "${destdir}"
progress_dialog 90 "Installation complete... Starting ${socket.name}..."
nohup "java" -jar "${jarfile}" > /dev/null 2>&1 &
progress_dialog 100 "Finished.  QZ Tray should start automatically."
exit 0
