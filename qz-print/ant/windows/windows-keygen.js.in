/**
 * @author Tres Finocchiaro
 *
 * Copyright (C) 2015 Tres Finocchiaro, QZ Industries
 */

/******************************************************************************
 *                        Windows KeyGen Utility                              *
 ******************************************************************************
 *  Description:                                                              *
 *    1. Creates a self-signed Java Keystore for jetty wss://localhost        *
 *    2. Exports public certificate from Java Keystore                        *
 *    3. Imports into Windows Trusted Root Certs                              *
 *                                                                            *
 *  Usage:                                                                    *
 *    > cscript //NoLogo windows-keygen.js                                    *
 *                                                                            *
 *****************************************************************************/
var shell = new ActiveXObject("WScript.shell");
var fso = new ActiveXObject("Scripting.FileSystemObject");

var javaKey = "HKLM\\Software\\JavaSoft\\Java Runtime Environment\\";
var jreHome = getRegValue(javaKey + getRegValue(javaKey + "CurrentVersion") + "\\JavaHome");

if (jreHome == "") {
	WScript.Echo("Can't find JavaHome");
	WScript.Exit(1);
}

var keyTool = jreHome + "\\bin\\keytool.exe";
var keyStore = programFiles("${jks.keystore}");
var derCert = programFiles("${der.cert}");
var password = pw();    // random password hash

var makeKeyStore = "${jks.command}"
    .replace("${jks.keytool}", keyTool)
    .replace("${jks.keystore}", keyStore)
    .replace("${jks.storepass}", password)
    .replace("${jks.keypass}", password);

deleteFile(keyStore);   // remove old, if exists
WScript.Echo("Creating keystore for secure websockets...");
shell.Run(makeKeyStore, 0, true);
verifyExists(keyStore, "Check keystore exists");

var makeDerCert = "${der.command}"
    .replace("${jks.keytool}", keyTool)
    .replace("${jks.keystore}", keyStore)
    .replace("${jks.storepass}", password)
    .replace("${jks.keypass}", password)
    .replace("${der.cert}", derCert);

deleteFile(derCert);    // remove old, if exists
WScript.Echo("Converting keystore to native certificate...");
shell.Run(makeDerCert, 0, true);
verifyExists(derCert, "Check certificate exists");

WScript.Echo("Installing native certificate for secure websockets...");
var deleteDerCert = 'certutil.exe -delstore "${build.windows.certstore}" "${vendor.company}"';
var installDerCert = 'certutil.exe -addstore -f "${build.windows.certstore}" "' + derCert + '"';
var verifyDerCert = 'certutil.exe -verifystore "${build.windows.certstore}" "${vendor.company}"';

shell.Run(deleteDerCert, 0, true);
shell.Run(installDerCert, 0, true);
verifyExec(verifyDerCert, "Check certificate installed");

var file = fso.OpenTextFile(programFiles("${jks.properties}"), 2, true);
file.WriteLine("wss.alias=" + "${jks.alias}");
file.WriteLine("wss.keystore=" + keyStore);
file.WriteLine("wss.keypass=" + password);
file.WriteLine("wss.storepass=" + password);
file.Close();

/**
 * Deletes a file
 */
function deleteFile(filePath) {
	if (fso.FileExists(filePath)) {
		try {
			fso.DeleteFile(filePath);
		} catch (err) {
			WScript.Echo("Unable to delete " + filePath);
		}
	}
}

/**
 * Generates a random string to be used as a password
 */
function pw() {
    var text = "";
    var chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    for( var i=0; i < 10; i++ ) {
        text += chars.charAt(Math.floor(Math.random() * chars.length));
	}
    return text;
}

/**
 * Reads a registry value, taking 32-bit/64-bit architecture into consideration
 */
function getRegValue(path) {	
	// If 64-bit OS, try 32-bit registry first
	var arch = "";
	if (shell.ExpandEnvironmentStrings("ProgramFiles(x86)")) {
		path = path.replace("\\Software\\", "\\Software\\Wow6432Node\\");
	}
	
	var regValue = "";
	try {
		regValue = shell.RegRead(path);
	} catch (err) {
		try {
		} catch (err) {
			// Fall back to 64-bit registry
			path = path.replace("\\Software\\Wow6432Node\\", "\\Software\\");
			regValue = shell.RegRead(path);
		}
	}
	return regValue;
}

/**
 * Displays a message regarding whether or not a file exists
 */
function verifyExists(path, msg) {
    WScript.Echo(" - " + msg + (fso.FileExists(path) ? " [success]" : " [failed]"));
}

/**
 * Displays a message regarding whether or not a command succeeded
 */
function verifyExec(cmd, msg) {
    WScript.Echo(" - " + msg + (shell.Run(cmd, 0, true) == 0 ? " [success]" : " [failed]"));
}

/**
 * Appends "Program Files" path, never with "(x86)", fixes slashes
 */
function programFiles(append) {
	var prog = shell.ExpandEnvironmentStrings("%programfiles%").replace(" (x86)", "");
    return append.replace("${jks.install}", prog).replace(/\//g, "\\");
}